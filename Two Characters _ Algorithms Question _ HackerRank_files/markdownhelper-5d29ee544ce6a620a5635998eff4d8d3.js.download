(function(){jQuery(function(){var HR,MarkdownToolbarHelper,ref;return MarkdownToolbarHelper=function(){function MarkdownToolbarHelper(options){var that;this.challengeModel=options.challengeModel,this.type=options.type,this.onEditorFocusCallback=options.onEditorFocusCallback,this.onEditorChangeCallback=options.onEditorChangeCallback,this.afterCodemirrorLoadCallback=options.afterCodemirrorLoadCallback,this.$textarea=options.$textarea,this.parentView=options.view,this.trackingNameSpace=options.trackingNameSpace,this.listCounter=0,this.action=null,this.defaultEditorOptions=$.extend({},this.defaultEditorOptions,options.editorOptions||{}),that=this,this.$textarea&&(this.editor=CodeMirror.fromTextArea(this.$textarea,this.defaultEditorOptions),this.editor.on("change",function(){return null==that.startedTyping&&(that.startedTyping=!0,hr_metrics.batch_track(that.trackingNameSpace+"StartedTyping","adding",{attribute1:that.challengeModel.get("slug"),attribute4:that.type})),null!=that.onEditorChangeCallback&&that.onEditorChangeCallback.apply(that.parentView),this}),this.editor.on("focus",function(){return null!=that.onEditorFocusCallback?that.onEditorFocusCallback.apply(that.parentView):void 0}))}return MarkdownToolbarHelper.prototype.defaultEditorOptions={lineWrapping:!0,matchBrackets:!0,mode:"text/x-markdown",indentUnit:4,autoCloseTags:!0,autoCloseBrackets:!0,viewportMargin:Infinity,lineNumbers:!0},MarkdownToolbarHelper.prototype.preview=function(e){var val;if(null!=this.editor)return val=this.editor.getValue(),null!=val&&""!==val?HR.util.previewHackdownWith(this.editor.getValue(),e):void 0},MarkdownToolbarHelper.prototype._apply=function(e){return this.action=$(e.currentTarget).attr("id"),this["__"+this.action](),this.editor.focus(),hr_metrics.batch_track("Click",this.trackingNameSpace+"Mkd-"+this.action,{attribute1:this.challengeModel.get("slug"),attribute4:this.type})},MarkdownToolbarHelper.prototype.textReplace=function(options){var endChar,endLine,modifiedStartChar,newText,numberOfStartLines,replaceItems,replaceText,selectedText,settings,startChar,startLine;return settings=$.extend({selected:function(){return""},no_selection:function(){return["","",""]}},options),selectedText=this.editor.getSelection(),this.startSelPos=this.currPos=this.editor.getCursor(!0),this.endSelPos=this.editor.getCursor(!1),selectedText?(replaceItems=settings.selected(selectedText),startLine=this.startSelPos.line,startChar=this.startSelPos.ch,endLine=this.endSelPos.line,endChar=this.endSelPos.ch,replaceItems&&(Array.isArray(replaceItems)?(newText=replaceItems.join(""),startChar+=replaceItems[0].length,endChar+=replaceItems[0].length,replaceText=replaceItems[1],replaceText.split(/\r\n|\r|\n/).length>1&&(replaceText=replaceText.split(/\r\n|\r|\n/)[replaceText.split(/\r\n|\r|\n/).length-1],endChar=replaceText.length)):newText=replaceItems,this.editor.replaceSelection(newText))):(replaceItems=settings.no_selection(),this.editor.replaceRange(replaceItems.join(""),CodeMirror.Pos(this.currPos.line,this.currPos.ch)),numberOfStartLines=0,numberOfStartLines=replaceItems[0].split(/\r\n|\r|\n/).length,numberOfStartLines>1&&(this.editor.setCursor({line:this.currPos.line+(numberOfStartLines-1),ch:0}),this.currPos=this.editor.getCursor(),replaceItems[0]=replaceItems[0].replace(/(\r\n|\n|\r)/gm,"")),startLine=this.startSelPos.line,startChar=this.startSelPos.ch+replaceItems[0].replace(/(\r\n|\n|\r)/gm,"").length,endLine=this.startSelPos.line,endChar=this.startSelPos.ch+(replaceItems[0]+replaceItems[1]).replace(/(\r\n|\n|\r)/gm,"").length),"numberedList"===this.action&&(modifiedStartChar=this.fixNumberForListItems(),null!=modifiedStartChar&&(startChar=modifiedStartChar,endChar=startChar+replaceItems[1].length)),Array.isArray(replaceItems)||"numberedList"===this.action&&replaceItems===!1?this.editor.setSelection(CodeMirror.Pos(startLine,startChar),CodeMirror.Pos(endLine,endChar)):void 0},MarkdownToolbarHelper.prototype.fixNumberForListItems=function(){var i,idx,len,newLineSeen,newValue,ref,ref1,text,textSplit,value;for(idx=0,value=this.editor.getValue(),newValue=[],textSplit=value.split(/\r\n|\r|\n/),newLineSeen=!0,i=0,len=textSplit.length;len>i;i++)text=textSplit[i],/^[0-9].*?\.\s*.*/.test(text)&&newLineSeen?text=text.replace(/(^)[0-9].*?(\.\s*.*)/,function(match,p1,p2){return""+p1+ ++idx+p2}):/^\s*$/.test(text)?newLineSeen=!0:(newLineSeen=!1,idx=0),newValue.push(text);return this.listCounter=idx,this.editor.setValue(newValue.join("\n")),this.editor.setCursor(this.editor.lineCount(),0),null!=(ref=this.editor.getLine(this.startSelPos.line).match(/^([0-9].*?\.\s*).*/))&&null!=(ref1=ref[1])?ref1.length:void 0},MarkdownToolbarHelper.prototype.checkAndSwitchOff=function(settings,text){var currLine,endChar,endLine,nextChars,prefixTerm,prevChars,ref,startChar,startLine;return startLine=this.startSelPos.line,startChar=this.startSelPos.ch,endLine=this.endSelPos.line,endChar=this.endSelPos.ch,prefixTerm=settings.startChars,"numberedList"===this.action&&(currLine=this.editor.getLine(this.currPos.line),prefixTerm=(null!=(ref=currLine.match(/^([0-9].*?)\.\s*.*(\r\n|\r|\n|$)/))?ref[1]:void 0)+". "),prevChars=this.editor.getRange({line:startLine,ch:startChar-prefixTerm.length},{line:startLine,ch:startChar}),nextChars=this.editor.getRange({line:endLine,ch:endChar},{line:endLine,ch:endChar+settings.endChars.length}),prevChars===prefixTerm&&nextChars===settings.endChars?(startChar-=prefixTerm.length,endChar-=prefixTerm.length,text.split(/\r\n|\r|\n/).length>1&&(text=text.split(/\r\n|\r|\n/)[text.split(/\r\n|\r|\n/).length-1],endChar=text.length),this.editor.replaceRange("",{line:startLine,ch:startChar},{line:startLine,ch:startChar+prefixTerm.length}),this.editor.replaceRange("",{line:endLine,ch:endChar},{line:endLine,ch:endChar+settings.endChars.length}),this.startSelPos=this.currPos=this.editor.getCursor(!0),this.endSelPos=this.editor.getCursor(!1),!0):!1},MarkdownToolbarHelper.prototype.addSpaceIfNeeded=function(){var currPos,prevChar;return currPos=this.editor.getCursor(),prevChar=this.editor.getRange({line:currPos.line,ch:currPos.ch-1},{line:currPos.line,ch:currPos.ch}),""!==prevChar&&" "!==prevChar?(this.editor.replaceSelection(" "),this.startSelPos=this.currPos=this.editor.getCursor(!0),this.endSelPos=this.editor.getCursor(!1)):void 0},MarkdownToolbarHelper.prototype.__bold=function(options){var settings;return settings=$.extend({"default":"Strong Text",startChars:"**",endChars:"**"},options),this.textReplace({selected:function(_this){return function(text){return _this.checkAndSwitchOff(settings,text)?!1:[settings.startChars,text,settings.endChars]}}(this),no_selection:function(_this){return function(){return _this.addSpaceIfNeeded(),[settings.startChars,settings["default"],settings.endChars]}}(this)})},MarkdownToolbarHelper.prototype.__italics=function(options){var settings;return settings=$.extend({"default":"Italic Text",startChars:"*",endChars:"*"},options),this.textReplace({selected:function(_this){return function(text){return _this.checkAndSwitchOff(settings,text)?!1:[settings.startChars,text,settings.endChars]}}(this),no_selection:function(_this){return function(){return _this.addSpaceIfNeeded(),[settings.startChars,settings["default"],settings.endChars]}}(this)})},MarkdownToolbarHelper.prototype.selectedListOption=function(settings,text){var currLine,currLinePrefixChars,finalText,i,index,len,line,lines,newLinesToBeAdded,prevLine,prevLinePrefixChars,ref,ref1;if(this.checkAndSwitchOff(settings,text))return!1;if(lines=text.split("\n"),prevLinePrefixChars=currLinePrefixChars=settings.startChars,"numberedList"===this.action&&(currLine=this.editor.getLine(this.currPos.line),currLinePrefixChars=(null!=(ref=currLine.match(/^([0-9].*?)\.\s*.*(\r\n|\r|\n|$)/))?ref[1]:void 0)+". ",prevLine=this.editor.getLine(this.currPos.line-1),prevLinePrefixChars=(null!=prevLine&&null!=(ref1=prevLine.match(/^([0-9].*?)\.\s*.*(\r\n|\r|\n|$)/))?ref1[1]:void 0)+". "),newLinesToBeAdded=0,0!==this.currPos.ch?(newLinesToBeAdded+=1,this.editor.getRange({line:this.currPos.line,ch:0},{line:this.currPos.line,ch:currLinePrefixChars.length})!==currLinePrefixChars&&(newLinesToBeAdded+=1)):0!==this.currPos.line&&/\S/.test(this.editor.getLine(this.currPos.line-1))&&this.editor.getRange({line:this.currPos.line-1,ch:0},{line:this.currPos.line-1,ch:prevLinePrefixChars.length})!==prevLinePrefixChars&&(newLinesToBeAdded+=1),1===lines.length)return this.editor.replaceSelection(Array(newLinesToBeAdded+1).join("\n")),this.editor.setCursor({line:this.currPos.line+newLinesToBeAdded,ch:0}),this.startSelPos=this.currPos=CodeMirror.Pos(this.startSelPos.line+newLinesToBeAdded,0),this.endSelPos=CodeMirror.Pos(this.endSelPos.line+newLinesToBeAdded,text.length),[settings.startChars,text,settings.endChars];for(finalText=Array(newLinesToBeAdded+1).join("\n"),index=i=0,len=lines.length;len>i;index=++i)line=lines[index],/\S/.test(line)&&(finalText+=""+settings.startChars+line+"\n","numberedList"===this.action&&(settings.startChars=++this.listCounter+". "));return finalText},MarkdownToolbarHelper.prototype.withoutSelectionListOption=function(settings){var currLine,currLinePrefixChars,newLinesToBeAdded,prevLine,prevLinePrefixChars,ref,ref1,startCharsToMatch;return newLinesToBeAdded=0,currLine=this.editor.getLine(this.currPos.line),prevLine=this.editor.getLine(this.currPos.line-1),startCharsToMatch=settings.startChars,this.editor.setCursor({line:this.currPos.line,ch:currLine.length}),prevLinePrefixChars=currLinePrefixChars=settings.startChars,"numberedList"===this.action&&(currLinePrefixChars=(null!=currLine&&null!=(ref=currLine.match(/^([0-9].*?)\.\s*.*(\r\n|\r|\n|$)/))?ref[1]:void 0)+". ",prevLinePrefixChars=(null!=prevLine&&null!=(ref1=prevLine.match(/^([0-9].*?)\.\s*.*(\r\n|\r|\n|$)/))?ref1[1]:void 0)+". "),""!==currLine.trim()?newLinesToBeAdded+=this.editor.getRange({line:this.currPos.line,ch:0},{line:this.currPos.line,ch:currLinePrefixChars.length})!==currLinePrefixChars?2:1:""===currLine.trim()&&null!=this.editor.getLine(this.currPos.line-1)&&this.editor.getRange({line:this.currPos.line-1,ch:0},{line:this.currPos.line-1,ch:prevLinePrefixChars.length})!==prevLinePrefixChars&&(newLinesToBeAdded+=1),this.editor.replaceSelection(Array(newLinesToBeAdded+1).join("\n")),this.editor.setCursor({line:this.currPos.line+newLinesToBeAdded,ch:0}),this.startSelPos=this.currPos=CodeMirror.Pos(this.startSelPos.line+newLinesToBeAdded,0),this.endSelPos=CodeMirror.Pos(this.endSelPos.line+newLinesToBeAdded,settings["default"].length),[settings.startChars,settings["default"],settings.endChars]},MarkdownToolbarHelper.prototype.__numberedList=function(options){var settings;return settings=$.extend({"default":"List Item",startChars:++this.listCounter+". ",endChars:""},options),this.textReplace({selected:function(_this){return function(text){return _this.selectedListOption(settings,text)}}(this),no_selection:function(_this){return function(){return _this.withoutSelectionListOption(settings)}}(this)})},MarkdownToolbarHelper.prototype.__bulletedList=function(options){var settings;return settings=$.extend({"default":"List Item",startChars:"- ",endChars:""},options),this.textReplace({selected:function(_this){return function(text){return _this.selectedListOption(settings,text)}}(this),no_selection:function(_this){return function(){return _this.withoutSelectionListOption(settings)}}(this)})},MarkdownToolbarHelper.prototype.__image=function(){var callback,cursor_head,dialog,that;return that=this,cursor_head=this.editor.getCursor(),dialog=new HR.util.ShowFormDialog({title:"Add Image",width:550,body:'<div class="forum-image-upload"> <div class="selector-box"> <input type="file" class="hide" id="file-selector" /> <label for="file"><span class="select-btn js-sel-img">Select Image</span><span class="box__dragndrop"> or drag it here</span>.</label> </div> <img src="" id="img-cropper" style="max-width: 100%;"/> </div>',buttons:[{name:"Upload",callback:function(dialog){var file,files,formData,i,image_files,img_id,len,results,url;for(image_files={},files=[that.file],results=[],i=0,len=files.length;len>i;i++)file=files[i],img_id=Math.floor(9876543210123*Math.random()),formData=new FormData,formData.append("file",file),formData.append("filename",file.name),image_files[img_id]={cursor:cursor_head,file:file.name,placeHolderText:"![Uploading "+file.name+" ....](...)"},$(".hr-dialog-button").addClass("disabled"),$(".hr-dialog-button").html("Uploading..."),url="Forum"===that.trackingNameSpace?"/rest/contests/master/challenges/"+that.challengeModel.get("slug")+"/comments/upload_image":"/rest/administration/challenges/upload_image",results.push($.ajax({url:url,type:"PUT",data:formData,cache:!1,dataType:"json",processData:!1,contentType:!1,index_id:img_id,success:function(data){var imgMarkup,selectedText,startCh;return selectedText=that.editor.getSelection(),imgMarkup="\n![image]("+data.s3_url+")",selectedText?(that.editor.replaceSelection(imgMarkup),that.currPos=that.editor.getCursor(),startCh=that.currPos.ch-imgMarkup.length,that.editor.setSelection({line:that.currPos.line,ch:startCh},{line:that.currPos.line,ch:that.currPos.ch})):(that.editor.replaceRange(imgMarkup,cursor_head),that.editor.setCursor(that.editor.lineCount(),0)),that.editor.focus(),hr_metrics.batch_track("#{that.trackingNameSpace}ImgAdded","",{attribute1:that.challengeModel.get("slug"),attribute4:that.type}),dialog.destroy()},error:function(error){return dialog.destroy(),alert("File too large or type not supported")}}));return results}}]}),callback=function(){var $forumImgUpload,readURL;return readURL=function(input){var reader;return input.files&&input.files[0]?(reader=new FileReader,reader.onload=function(e){return $(".selector-box").hide(),$("#img-cropper").attr("src",e.target.result)},reader.readAsDataURL(input.files[0])):void 0},$("#file-selector").change(function(){var ref;return readURL(this),that.file=null!=(ref=this.files)?ref[0]:void 0}),$(".js-sel-img").click(function(){return $("#file-selector").click()}),Modernizr.draganddrop?($forumImgUpload=$(".forum-image-upload"),$forumImgUpload.addClass("advanced-upload"),$forumImgUpload.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){return e.preventDefault(),e.stopPropagation()}).on("dragover dragenter",function(){return $forumImgUpload.addClass("is-dragover")}).on("dragleave dragend drop",function(){return $forumImgUpload.removeClass("is-dragover")}).on("drop",function(e){var dataTransfer;return dataTransfer=e.originalEvent.dataTransfer,readURL(dataTransfer),that.file=dataTransfer.files[0]})):void 0},dialog.render(callback),$(".hr-dialog").css("z-index",9999)},MarkdownToolbarHelper.prototype.__code=function(){return this.addSnippet()},MarkdownToolbarHelper.prototype.__link=function(){var cursor_head,dialog,that;return that=this,cursor_head=this.editor.getCursor(),dialog=new HR.util.ShowFormDialog({title:"Add a link",width:650,body:'<div class="add-link-dialog"> <div class="row"> <span class="span2">Title:</span> <span class="span12"><input type="text" id="forum-link-title" /></span> </div> <div class="row"> <span class="span2">Link:</span> <span class="span12"><input type="text" id="forum-link" value="http://" /></span> </div> </div>',buttons:[{name:"Add",callback:function(dialog){var link,linkMarkup,selectedText,startCh,title;return title=$("#forum-link-title").val(),link=$("#forum-link").val(),selectedText=that.editor.getSelection(),that.addSpaceIfNeeded(),linkMarkup="["+title+"]("+link+")",selectedText?(that.editor.replaceSelection(linkMarkup),that.currPos=that.editor.getCursor(),startCh=that.currPos.ch-linkMarkup.length,that.editor.setSelection({line:that.currPos.line,ch:startCh},{line:that.currPos.line,ch:that.currPos.ch})):that.editor.replaceRange(linkMarkup,cursor_head),that.editor.focus(),hr_metrics.batch_track(that.trackingNameSpace+"LinkAdded","",{attribute1:that.challengeModel.get("slug"),attribute4:that.type}),dialog.destroy()}}]}),dialog.render(),$(".hr-dialog").css("z-index",9999)},MarkdownToolbarHelper.prototype.addSnippet=function(e){var $editor,beforePositioningCallback,cursor_head,dialog,that;return that=this,cursor_head=this.editor.getCursor(),dialog=new HR.util.ShowFormDialog({title:"Add a Code Snippet",width:650,body:"<div id='js-snippet-box'></div>",buttons:[{name:"Add",callback:function(dialog){var escaped_code,selectedText,snippet;return escaped_code=$editor.getValue().replace(/^\s+|\s+$/g,""),that.snippetLang=$(".hr-dialog-body #select-lang").val(),""===escaped_code?void dialog.destroy():(snippet="\n```"+that.snippetLang+"\n"+escaped_code+"\n```\n",selectedText=that.editor.getSelection(),selectedText?that.editor.replaceSelection(snippet):that.editor.replaceRange(snippet,cursor_head),that.editor.focus(),hr_metrics.batch_track(that.trackingNameSpace+"SnippetAdded","",{attribute1:that.challengeModel.get("slug"),attribute4:that.type}),dialog.destroy())}}]}),beforePositioningCallback=function(){return $("#js-snippet-box").codeshell({languages:that.challengeModel.get("languages"),defaultLanguage:that.challengeModel.get("default_language"),forumMkdTool:!0,showCustomInput:!1,showCompileTest:!1,showSubmit:!1,showUploadCode:!1,showFullScreen:!1,showTheme:!1,foldCode:!1,dynamicMode:!0,loadmode:function(e,data){var lines,newLinesToBeAdded,val;return val="","undefined"!=typeof $editor&&null!==$editor&&(val=$editor.getValue()),lines=val.split(/\r\n|\r|\n/).length,newLinesToBeAdded="",14>lines&&(newLinesToBeAdded=Array(14-lines).join("\n")),HR.appController.loadCodeMirrorMode(data.lang,function(){return data.callback(),setTimeout(function(){return $editor.setValue(val+newLinesToBeAdded),$editor.focus(),$editor.on("change",function(){return null==that.startedTyping?(that.startedTyping=!0,hr_metrics.batch_track(that.trackingNameSpace+"SnippetModalStartedTyping","adding",{attribute1:that.challengeModel.get("slug"),attribute4:that.type})):void 0})},500)})}}),$(".hr-dialog #codeeditor-statusbar").hide(),$(".hr-dialog .code-body").css({overflow:"scroll",height:"300px"}),$(".hr-dialog #show-preferences").hide()},dialog.render(beforePositioningCallback),$(".hr-dialog").css("z-index",9999),that.startedTyping=null,$editor=$("#js-snippet-box").codeshell("getEditor")},MarkdownToolbarHelper}(),HR=null!=(ref=window.HR)?ref:{},HR.util||(HR.util={}),HR.util.MarkdownToolbarHelper=MarkdownToolbarHelper})}).call(this);